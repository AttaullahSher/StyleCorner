<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StyleCorner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.2/jsrsasign-all-min.js"></script>
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-blue-600 text-white p-3 sticky top-0 z-10 shadow">
    <div class="flex justify-between items-center max-w-5xl mx-auto">
      <h1 class="text-lg font-bold flex items-center"><i class="fas fa-tshirt mr-2"></i> StyleCorner</h1>
      <button id="menuToggle" class="text-2xl"><i class="fas fa-bars"></i></button>
    </div>
  </header>
  <nav id="menu" class="hidden bg-white p-3 shadow max-w-5xl mx-auto">
    <a href="#partners" class="block text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fas fa-users mr-2"></i> Partners</a>
    <a href="#inventory" class="block text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fas fa-box mr-2"></i> Inventory</a>
    <a href="#record" class="block text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fas fa-plus mr-2"></i> Record</a>
    <a href="#transactions" class="block text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fas fa-list mr-2"></i> Transactions</a>
  </nav>
  <div class="container mx-auto p-3 max-w-5xl">
    <!-- Partners' Shares -->
    <div id="partners" class="mb-4">
      <h2 class="text-lg font-semibold text-blue-800 flex justify-between items-center cursor-pointer" onclick="toggleSection('partnersList')">
        <span><i class="fas fa-users mr-2"></i> Partners' Shares</span>
        <i class="fas fa-chevron-down"></i>
      </h2>
      <div id="partnersList" class="hidden grid grid-cols-1 gap-3 mt-2"></div>
      <p class="mt-2 text-blue-800 text-sm"><i class="fas fa-coins mr-2"></i> Total Cash: <span id="totalCash" class="font-bold">0 PKR</span></p>
    </div>

    <!-- Inventory -->
    <div id="inventory" class="mb-4">
      <h2 class="text-lg font-semibold text-blue-800 mb-2"><i class="fas fa-box mr-2"></i> Inventory</h2>
      <div id="inventoryList" class="grid grid-cols-2 gap-2 sm:grid-cols-4"></div>
    </div>

    <!-- Record Transaction -->
    <div id="record" class="mb-4">
      <h2 class="text-lg font-semibold text-blue-800 mb-2"><i class="fas fa-plus mr-2"></i> Record Transaction</h2>
      <div class="bg-white p-4 rounded-lg shadow">
        <select id="transactionType" class="border p-2 rounded w-full text-sm mb-3" onchange="updateForm()">
          <option value="purchase">Purchase</option>
          <option value="sale">Sale</option>
          <option value="refund">Refund</option>
          <option value="expense">Expense</option>
        </select>
        <div id="transactionForm" class="grid grid-cols-1 gap-2"></div>
      </div>
    </div>

    <!-- Transactions -->
    <div id="transactions">
      <h2 class="text-lg font-semibold text-blue-800 mb-2 flex justify-between items-center">
        <span><i class="fas fa-list mr-2"></i> Transactions</span>
        <button id="toggleTransactions" class="text-blue-600 text-sm">Hide</button>
      </h2>
      <div id="transactionsList" class="space-y-2"></div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button onclick="exportCSV('inventory')" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm"><i class="fas fa-download mr-1"></i> Export Inventory</button>
        <button onclick="exportCSV('transactions')" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm"><i class="fas fa-download mr-1"></i> Export Transactions</button>
        <button onclick="exportCSV('expenses')" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm"><i class="fas fa-download mr-1"></i> Export Expenses</button>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1UfLjgdC5rsVOm4bKar81GHUZy_X8TEFU928JrDPG418";
    const SERVICE_ACCOUNT = {
      client_email: "stylecorner-service-account@able-winter-358811.iam.gserviceaccount.com",
      private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC0KsQoPr2XnOUH\n4g4PM9ui2HChtXM411o3uhGcoXSMHpqqA5B7yqfXaNsUwXuWEF+qa2a0RpT0z61u\n7qJqwEn7iZDNHWp2kwc7JNGzmzhIBP0jwddmpR/2GNI7KKb7vu58wG+k7GXJG04c\nGHURnz/X/HHgEEnTgpa5rBVw6LwzQwtL21T5q6GRaC2tQNfqE5JO9WDRYDKUXLIT\nTQNy8HLftvR027oubSnNVKtlXtWhsiRFNnmaWVtT3gtei79dQf7KYTQxKlxjfId0\nGnwMVc5aTao7pEyrCIfch/cMM+3spD1ZcBE7ZgO/lQvjBElN43bu7jlzH2R7pkBq\nPWlxBuWDAgMBAAECggEASrCkC08fSBg59o+nZnQILLVv1AomDz1v4ERaAsYITAJv\n+eVqY3d7J1kH4c3oTyjQkBTgSgIsxGTIMIHrgTfgM9Au4Gm+dhOz3rf/22aQ6YJv\n8v/sLVhtLJfTp8TNnPXlZoBciFGcTMfuFMWq2rhbPk4gY1Q9Vtr/Y0/Mv7csNk91\nxrZ/YsrZaTaUAQAzcSlpYuFlo1jpiE1eft49qub0LbBulU9Ciwt1ertHij+sYVDG\n4UeA2B8m3QRAGrLpAYy58s6xG//I3hxxks8dfn1hasakH1km5RtsYyw4mS4/GCx1\ngj7tkSONIwjGNNLSqyic441r/aN82oKRuyJj4/AjCQKBgQDgRHKCsS9XnSAC/v6D\nwqB29g+MIXFPiFtdnh+iGIPezRzxyFSbaIJVqTFrAA4r7ssG+Po4rP3iBBlP69Tk\nk4Bt6jQ43XT326LLAOBa8dq6hyUJFIJBALfZq7/Ye21MgqGRy80RQa2wAvjGef0N\nWN0BcaIl6AU2WvV4JaxoSYTjfwKBgQDNqOPGVSp9fqbGqi/H9AhMLmxVCJf+Y5Qw\n4rKP9KCBTAaopPQfAXyBS/WgDrX6JfWh91NY1eoG7iQO/Q4qlTzTkCnHZJ96Kmxo\n6GYZ7V30D2MFjyU6Y5ilFTJBssFB0Z/eZl54x9+154CkX8GY5p//iXfWuHUrLbCL\nYeXE5PJv/QKBgQC7haA2VY+fc9uDhdItPD1Om1rOslv7w6mZ8xDCSjthviJ4rSjJ\nta5dkBapQKeY5pfPIbqgT04OgZzkre4anpdh0NaPweT/JyDNG9N9WAOrujsmh4aO\ncdpI4QqOKk5vDj+pGD9FMaTYqvN3iiMk2OwbO/f4ODS7iXz9VIr/vJGoYwKBgBTd\ncqZ3k4UB6Xe0Yn6d0o2wFAuYgJstjSZciZMzVWloxjAr9ByFMRWJGFVxyKKlYUNa\nbVlQ8ppbZMskf2Bwnag1MxforIlfbnpCQcGVpHeTbA9vU26WFjGBcgTaVuMPmnGc\n3y7P0HGLGDEVCfYyR79MOh1Nv41u6D9r4jzUoYgdAoGBAK1YfVqWhytEbhoI7jH/\nTssllH/6jNqKWDgs1KgjqdboBaqKJSXP8Ycc8YTxXRUX3oh4SfaWgS5xMOxA8Lo9\n0U0K/v+ZAgW10gNu7xO2d5FRG+cPY21AJex0l6U5ABGUJCOaJ0QH30fWfcB5+Epv\nS+C4eQNceWZ7tbFds7cCaIZw\n-----END PRIVATE KEY-----\n"
    };
    const partners = [
      { name: "Hafsa", investment: 25000 },
      { name: "Talha", investment: 25000 },
      { name: "Waseem", investment: 25000 },
      { name: "Atta", investment: 25000 }
    ];
    const PASSWORD = "2532";
    let totalCash = partners.reduce((sum, p) => sum + p.investment, 0);
    let inventory = [];
    let transactions = [];
    let expenses = [];

    // Generate JWT Token
    async function getAccessToken() {
      const header = { alg: "RS256", typ: "JWT" };
      const now = Math.floor(Date.now() / 1000);
      const payload = {
        iss: SERVICE_ACCOUNT.client_email,
        scope: "https://www.googleapis.com/auth/spreadsheets",
        aud: "https://oauth2.googleapis.com/token",
        exp: now + 3600,
        iat: now
      };
      const sHeader = JSON.stringify(header);
      const sPayload = JSON.stringify(payload);
      const key = KEYUTIL.getKey(SERVICE_ACCOUNT.private_key);
      const jwt = KJUR.jws.JWS.sign("RS256", sHeader, sPayload, key);
      const tokenResponse = await axios.post("https://oauth2.googleapis.com/token", {
        grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
        assertion: jwt
      });
      return tokenResponse.data.access_token;
    }

    // Toggle Section
    function toggleSection(id) {
      const el = document.getElementById(id);
      el.classList.toggle("hidden");
      el.previousElementSibling.querySelector("i.fa-chevron-down").classList.toggle("fa-chevron-up");
    }

    // Load Data from Google Sheets
    async function loadData() {
      try {
        const accessToken = await getAccessToken();
        const headers = { Authorization: `Bearer ${accessToken}` };
        const [invRes, transRes, expRes] = await Promise.all([
          axios.get(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Inventory`, { headers }),
          axios.get(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Transactions`, { headers }),
          axios.get(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Expenses`, { headers }),
        ]);
        inventory = invRes.data.values?.slice(1).map(row => ({
          category: row[0],
          quantity: parseInt(row[1]) || 0,
          total_value: parseFloat(row[2]) || 0
        })) || [
          { category: "Male Unstitched", quantity: 0, total_value: 0 },
          { category: "Female Unstitched", quantity: 0, total_value: 0 },
          { category: "Male Stitched", quantity: 0, total_value: 0 },
          { category: "Female Stitched", quantity: 0, total_value: 0 }
        ];
        transactions = transRes.data.values?.slice(1).map(row => ({
          type: row[0],
          category: row[1] || "",
          quantity: parseInt(row[2]) || "",
          amount: parseFloat(row[3]) || 0,
          date: row[4],
          name: row[5] || ""
        })) || [];
        expenses = expRes.data.values?.slice(1).map(row => ({
          type: row[0],
          amount: parseFloat(row[1]) || 0,
          date: row[2],
          receipt: row[3] || "None"
        })) || [];
        totalCash = parseFloat(localStorage.getItem("totalCash")) || partners.reduce((sum, p) => sum + p.investment, 0);
        updateUI();
      } catch (err) {
        console.error("Error loading data:", err);
        alert("Failed to load data from Google Sheets.");
      }
    }

    // Save Data to Google Sheets
    async function saveToSheets() {
      try {
        const accessToken = await getAccessToken();
        const headers = { Authorization: `Bearer ${accessToken}` };
        const invData = [["category", "quantity", "total_value"], ...inventory.map(i => [i.category, i.quantity.toString(), i.total_value.toString()])];
        const transData = [["type", "category", "quantity", "amount", "date", "name"], ...transactions.map(t => [t.type, t.category, t.quantity.toString(), t.amount.toString(), t.date, t.name])];
        const expData = [["type", "amount", "date", "receipt"], ...expenses.map(e => [e.type, e.amount.toString(), e.date, e.receipt])];
        await Promise.all([
          axios.post(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Inventory:clear`, {}, { headers }),
          axios.post(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Transactions:clear`, {}, { headers }),
          axios.post(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Expenses:clear`, {}, { headers }),
          axios.post(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Inventory?valueInputOption=RAW`, { values: invData }, { headers }),
          axios.post(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Transactions?valueInputOption=RAW`, { values: transData }, { headers }),
          axios.post(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Expenses?valueInputOption=RAW`, { values: expData }, { headers }),
        ]);
        localStorage.setItem("totalCash", totalCash.toString());
      } catch (err) {
        console.error("Error saving data:", err);
        alert("Failed to save data to Google Sheets.");
      }
    }

    // Update UI
    function updateUI() {
      const totalInvestment = partners.reduce((sum, p) => sum + p.investment, 0);
      const profit = totalCash - totalInvestment - expenses.reduce((sum, e) => sum + e.amount, 0);
      document.getElementById("partnersList").innerHTML = partners.map(p => `
        <div class="bg-white p-3 rounded-lg shadow flex items-center">
          <i class="fas fa-user text-blue-600 mr-2"></i>
          <div>
            <p class="font-semibold text-blue-800 text-sm">${p.name}</p>
            <p class="text-sm">${p.investment.toFixed(2)} PKR</p>
            <p class="text-sm font-bold">${((p.investment / totalInvestment) * (profit + totalInvestment)).toFixed(2)} PKR</p>
          </div>
        </div>
      `).join("");
      document.getElementById("totalCash").textContent = `${totalCash.toFixed(2)} PKR`;

      document.getElementById("inventoryList").innerHTML = inventory.map(item => `
        <div class="bg-white p-3 rounded-lg shadow flex items-center">
          <i class="fas fa-tshirt text-blue-600 mr-2"></i>
          <div>
            <p class="font-medium text-blue-800 text-sm">${item.category}</p>
            <p class="text-sm">${item.quantity}pcs</p>
            <p class="text-sm">${item.total_value.toFixed(0)}</p>
          </div>
        </div>
      `).join("");

      const allTransactions = [...transactions, ...expenses.map(e => ({
        type: "Expense",
        category: "",
        quantity: "",
        amount: e.amount,
        date: e.date,
        name: e.type,
        receipt: e.receipt
      }))].sort((a, b) => new Date(b.date) - new Date(a.date));
      document.getElementById("transactionsList").innerHTML = allTransactions.map((t, index) => `
        <div class="bg-white p-3 rounded-lg shadow flex justify-between items-center">
          <div class="text-sm">
            <p class="font-medium ${t.type === 'Purchase' ? 'text-blue-600' : t.type === 'Sale' ? 'text-green-600' : t.type === 'Refund' ? 'text-yellow-600' : 'text-red-600'}">
              <i class="fas ${t.type === 'Purchase' ? 'fa-shopping-cart' : t.type === 'Sale' ? 'fa-money-bill' : t.type === 'Refund' ? 'fa-undo' : 'fa-wallet'} mr-2"></i>
              ${t.type}
            </p>
            ${t.category ? `<p>${t.category}</p>` : ""}
            ${t.quantity ? `<p>${t.quantity}pcs</p>` : ""}
            <p>${t.amount.toFixed(2)} PKR</p>
            <p>${t.date}</p>
            <p>${t.name}</p>
            ${t.receipt !== "None" ? `<p>${t.receipt}</p>` : ""}
          </div>
          <button onclick="deleteTransaction(${index})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
        </div>
      `).join("");
    }

    function updateForm() {
      const type = document.getElementById("transactionType").value;
      const commonFields = `
        ${type !== "expense" ? `
          <div>
            <label class="block text-xs font-medium text-gray-700">Category</label>
            <select id="category" class="border p-2 rounded w-full text-sm">
              <option value="Male Unstitched">Male Unstitched</option>
              <option value="Female Unstitched">Female Unstitched</option>
              <option value="Male Stitched">Male Stitched</option>
              <option value="Female Stitched">Female Stitched</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700">Quantity</label>
            <input id="quantity" type="number" placeholder="Quantity" class="border p-2 rounded w-full text-sm" min="1">
          </div>
        ` : ""}
        <div>
          <label class="block text-xs font-medium text-gray-700">Amount (PKR)</label>
          <input id="amount" type="number" placeholder="Amount" class="border p-2 rounded w-full text-sm" min="0" step="0.01">
        </div>
      `;
      document.getElementById("transactionForm").innerHTML = `
        ${type === "expense" ? `
          <div>
            <label class="block text-xs font-medium text-gray-700">Type</label>
            <select id="expenseType" class="border p-2 rounded w-full text-sm">
              <option value="Stitching">Stitching</option>
              <option value="Courier">Courier</option>
              <option value="Marketing">Marketing</option>
              <option value="Other">Other</option>
            </select>
          </div>
        ` : `
          <div>
            <label class="block text-xs font-medium text-gray-700">${type === "purchase" ? "Supplier" : "Customer"} Name</label>
            <input id="name" type="text" placeholder="${type === "purchase" ? "Supplier" : "Customer"} Name" class="border p-2 rounded w-full text-sm">
          </div>
        `}
        ${commonFields}
        ${type === "purchase" || type === "expense" ? `
          <div>
            <label class="block text-xs font-medium text-gray-700">Receipt (Optional)</label>
            <input id="receipt" type="file" accept=".pdf,.jpg,.png" class="border p-2 rounded w-full text-sm">
          </div>
        ` : ""}
        <button onclick="addTransaction()" class="bg-${type === 'purchase' ? 'blue' : type === 'sale' ? 'green' : type === 'refund' ? 'yellow' : 'red'}-500 text-white p-2 rounded hover:bg-${type === 'purchase' ? 'blue' : type === 'sale' ? 'green' : type === 'refund' ? 'yellow' : 'red'}-600 text-sm"><i class="fas fa-plus mr-1"></i> Add ${type.charAt(0).toUpperCase() + type.slice(1)}</button>
      `;
    }

    async function addTransaction() {
      const type = document.getElementById("transactionType").value;
      const category = document.getElementById("category")?.value;
      const quantity = parseInt(document.getElementById("quantity")?.value) || 0;
      const amount = parseFloat(document.getElementById("amount").value);
      const name = document.getElementById("name")?.value;
      const expenseType = document.getElementById("expenseType")?.value;
      const receipt = document.getElementById("receipt")?.files[0];

      if ((type !== "expense" && category && quantity > 0 && amount > 0 && name) || (type === "expense" && expenseType && amount > 0)) {
        if (type === "sale" && (!inventory.find(i => i.category === category) || inventory.find(i => i.category === category).quantity < quantity)) {
          alert("Insufficient inventory!");
          return;
        }

        if (type !== "expense") {
          let item = inventory.find(i => i.category === category);
          if (!item && (type === "purchase" || type === "refund")) {
            item = { category, quantity: 0, total_value: 0 };
            inventory.push(item);
          }
          if (type === "purchase") {
            item.quantity += quantity;
            item.total_value += amount;
            totalCash -= amount;
          } else if (type === "sale") {
            item.quantity -= quantity;
            item.total_value -= (item.total_value / (item.quantity + quantity)) * quantity;
            totalCash += amount;
          } else if (type === "refund") {
            item.quantity += quantity;
            item.total_value += amount;
            totalCash -= amount;
          }
          transactions.push({ type: type.charAt(0).toUpperCase() + type.slice(1), category, quantity, amount, date: new Date().toISOString().split("T")[0], name });
        } else {
          expenses.push({ type: expenseType, amount, date: new Date().toISOString().split("T")[0], receipt: receipt ? receipt.name : "None" });
          totalCash -= amount;
        }

        await saveToSheets();
        updateUI();
        document.getElementById("transactionForm").querySelectorAll("input, select").forEach(el => el.value = "");
      } else {
        alert("Please fill all fields correctly.");
      }
    }

    async function deleteTransaction(index) {
      const password = prompt("Enter password to delete:");
      if (password !== PASSWORD) {
        alert("Incorrect password!");
        return;
      }

      const allTransactions = [...transactions, ...expenses.map(e => ({
        type: "Expense",
        category: "",
        quantity: "",
        amount: e.amount,
        date: e.date,
        name: e.type,
        receipt: e.receipt
      }))].sort((a, b) => new Date(b.date) - new Date(a.date));
      const transaction = allTransactions[index];

      if (transaction.type === "Purchase") {
        const item = inventory.find(i => i.category === transaction.category);
        if (item) {
          item.quantity -= transaction.quantity;
          item.total_value -= transaction.amount;
          if (item.quantity <= 0) inventory = inventory.filter(i => i.category !== transaction.category);
        }
        totalCash += transaction.amount;
        transactions = transactions.filter(t => t !== transaction);
      } else if (transaction.type === "Sale") {
        const item = inventory.find(i => i.category === transaction.category);
        if (item) {
          item.quantity += transaction.quantity;
          item.total_value += transaction.amount;
        }
        totalCash -= transaction.amount;
        transactions = transactions.filter(t => t !== transaction);
      } else if (transaction.type === "Refund") {
        const item = inventory.find(i => i.category === transaction.category);
        if (item) {
          item.quantity -= transaction.quantity;
          item.total_value -= transaction.amount;
          if (item.quantity <= 0) inventory = inventory.filter(i => i.category !== transaction.category);
        }
        totalCash += transaction.amount;
        transactions = transactions.filter(t => t !== transaction);
      } else if (transaction.type === "Expense") {
        totalCash += transaction.amount;
        expenses = expenses.filter(e => e.date !== transaction.date || e.amount !== transaction.amount || e.type !== transaction.name);
      }

      await saveToSheets();
      updateUI();
    }

    function exportCSV(type) {
      let data, headers, filename;
      if (type === "inventory") {
        headers = ["category", "quantity", "total_value"];
        data = inventory;
        filename = "inventory.csv";
      } else if (type === "transactions") {
        headers = ["type", "category", "quantity", "amount", "date", "name"];
        data = transactions;
        filename = "transactions.csv";
      } else {
        headers = ["type", "amount", "date", "receipt"];
        data = expenses;
        filename = "expenses.csv";
      }
      const csv = [headers.join(","), ...data.map(row => headers.map(h => row[h] || "").join(","))].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("toggleTransactions").addEventListener("click", (e) => {
      const list = document.getElementById("transactionsList");
      list.classList.toggle("hidden");
      e.target.textContent = list.classList.contains("hidden") ? "Show" : "Hide";
    });

    document.getElementById("menuToggle").addEventListener("click", () => {
      document.getElementById("menu").classList.toggle("hidden");
    });

    updateForm();
    loadData();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>StyleCorner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    #partners, #inventory, #record, #transactions {
      border: 2px solid #10b981; /* Green border */
      border-radius: 1rem;
      padding: 1.5rem;
      background-color: #f9fafb;
    }
    #partnersList i,
    #inventoryList i {
      display: none;
    }
    /* 4-card grid on mobile */
    @media (max-width: 640px) {
      #partnersList {
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.5rem;
      }
      #partnersList > div {
        padding: 0.5rem;
      }
      #partnersList p {
        font-size: 0.75rem;
      }
    }
    /* Bold 0 pcs in inventory */
    .zero-pcs {
      font-weight: bold;
      color: #ef4444; /* Red for emphasis */
    }
    /* Enhanced button styles */
    button {
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900">
  <div id="loading" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-500"></div>
  </div>
  <div id="notification" class="fixed bottom-4 right-4 bg-red-600 text-white p-3 rounded-lg shadow-lg hidden"></div>

  <header class="bg-green-600 text-white p-4 sticky top-0 z-10 shadow-lg">
    <div class="flex justify-center items-center max-w-5xl mx-auto">
      <h1 class="text-2xl font-bold flex items-center"><i class="fas fa-tshirt mr-3"></i> StyleCorner</h1>
    </div>
  </header>

  <div class="container mx-auto p-4 max-w-5xl">
    <!-- Partners' Shares -->
    <div id="partners" class="mb-6">
      <h2 class="text-xl font-semibold text-green-800 flex items-center mb-4">
        <i class="fas fa-users mr-2"></i> Partners' Shares
      </h2>
      <div id="partnersList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200 border border-green-200">
          <div class="text-center">
            <p class="font-semibold text-green-800 text-sm">Aqil</p>
            <p class="text-sm">25%</p>
            <p class="text-sm font-bold bg-green-100 text-green-800 px-2 py-1 rounded-full" id="aqilShare">25000</p>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200 border border-green-200">
          <div class="text-center">
            <p class="font-semibold text-green-800 text-sm">Talha</p>
            <p class="text-sm">25%</p>
            <p class="text-sm font-bold bg-green-100 text-green-800 px-2 py-1 rounded-full" id="talhaShare">25000</p>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200 border border-green-200">
          <div class="text-center">
            <p class="font-semibold text-green-800 text-sm">Atta</p>
            <p class="text-sm">25%</p>
            <p class="text-sm font-bold bg-green-100 text-green-800 px-2 py-1 rounded-full" id="attaShare">25000</p>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200 border border-green-200">
          <div class="text-center">
            <p class="font-semibold text-green-800 text-sm">Waseem</p>
            <p class="text-sm">25%</p>
            <p class="text-sm font-bold bg-green-100 text-green-800 px-2 py-1 rounded-full" id="waseemShare">25000</p>
          </div>
        </div>
      </div>
      <p class="mt-4 text-green-800 text-sm flex items-center">
        <i class="fas fa-coins mr-2"></i> Total Cash: 
        <span id="totalCash" class="font-bold bg-green-100 text-green-800 px-2 py-1 rounded-full ml-1">100000.00 PKR</span>
      </p>
    </div>

    <!-- Inventory -->
    <div id="inventory" class="mb-6">
      <h2 class="text-xl font-semibold text-green-800 flex items-center mb-4">
        <i class="fas fa-box mr-2"></i> Inventory
      </h2>
      <div id="inventoryList" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
    </div>

    <!-- Record Transaction -->
    <div id="record" class="mb-6">
      <h2 class="text-xl font-semibold text-green-800 flex items-center mb-4">
        <i class="fas fa-plus mr-2"></i> Record Transaction
      </h2>
      <div class="p-5 rounded-lg shadow-md border border-green-200">
        <select id="transactionType" class="border p-2 rounded w-full text-sm mb-4 focus:ring-2 focus:ring-green-500" onchange="updateForm()">
          <option value="purchase">Purchase</option>
          <option value="sale">Sale</option>
          <option value="refund">Refund</option>
          <option value="expense">Expense</option>
        </select>
        <div id="transactionForm" class="grid grid-cols-1 gap-4"></div>
      </div>
    </div>

    <!-- Transactions -->
    <div id="transactions">
      <h2 class="text-xl font-semibold text-green-800 flex items-center mb-4">
        <span><i class="fas fa-list mr-2"></i> Transactions</span>
        <button id="toggleTransactions" class="text-green-600 text-sm hover:text-green-800 transition-colors ml-2">Hide</button>
      </h2>
      <div id="transactionsList" class="space-y-3"></div>
      <div class="mt-4 flex flex-wrap gap-3">
        <button onclick="exportCSV('inventory')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm flex items-center">
          <i class="fas fa-download mr-2"></i> Export Inventory
        </button>
        <button onclick="exportCSV('transactions')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm flex items-center">
          <i class="fas fa-download mr-2"></i> Export Transactions
        </button>
        <button onclick="exportCSV('expenses')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm flex items-center">
          <i class="fas fa-download mr-2"></i> Export Expenses
        </button>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1UfLjgdC5rsVOm4bKar81GHUZy_X8TEFU928JrDPG418";
    const API_KEY = "AIzaSyCGwzmW2Ylzq4jHJmawcEOUxiv7WQSKGKI";
    const partners = [
      { name: "Aqil", investment: 25000 },
      { name: "Talha", investment: 25000 },
      { name: "Atta", investment: 25000 },
      { name: "Waseem", investment: 25000 }
    ];
    const PASSWORD = "2532";
    let totalCash = 100000; // Initial cash in hand as a number
    let inventory = [];
    let transactions = [];
    let expenses = [];

    async function loadData() {
      document.getElementById("loading").classList.remove("hidden");
      try {
        const [invRes, transRes, expRes] = await Promise.all([
          axios.get(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Inventory?key=${API_KEY}`),
          axios.get(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Transactions?key=${API_KEY}`),
          axios.get(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Expenses?key=${API_KEY}`),
        ]);

        // Load inventory
        inventory = invRes.data.values?.slice(1).map(row => ({
          category: row[0],
          quantity: parseInt(row[1]) || 0,
          total_value: parseFloat(row[2]) || 0
        })) || [
          { category: "Male Unstitched", quantity: 0, total_value: 0 },
          { category: "Female Unstitched", quantity: 0, total_value: 0 },
          { category: "Male Stitched", quantity: 0, total_value: 0 },
          { category: "Female Stitched", quantity: 0, total_value: 0 }
        ];

        // Load transactions
        transactions = transRes.data.values?.slice(1).map(row => ({
          type: row[0],
          category: row[1] || "",
          quantity: parseInt(row[2]) || "",
          amount: parseFloat(row[3]) || 0,
          date: row[4],
          name: row[5] || ""
        })) || [];

        // Load expenses
        expenses = expRes.data.values?.slice(1).map(row => ({
          type: row[0],
          amount: parseFloat(row[1]) || 0,
          date: row[2]
        })) || [];

        // Check if all sheets are empty
        const isInventoryEmpty = !invRes.data.values || invRes.data.values.length <= 1;
        const isTransactionsEmpty = !transRes.data.values || transRes.data.values.length <= 1;
        const isExpensesEmpty = !expRes.data.values || expRes.data.values.length <= 1;

        if (isInventoryEmpty && isTransactionsEmpty && isExpensesEmpty) {
          // Reset totalCash and clear localStorage if all sheets are empty
          totalCash = 100000;
          localStorage.removeItem("totalCash");
        } else {
          // Recalculate totalCash and inventory based on transactions and expenses
          totalCash = 100000; // Start from initial cash
          inventory = [
            { category: "Male Unstitched", quantity: 0, total_value: 0 },
            { category: "Female Unstitched", quantity: 0, total_value: 0 },
            { category: "Male Stitched", quantity: 0, total_value: 0 },
            { category: "Female Stitched", quantity: 0, total_value: 0 }
          ];

          // Process transactions to update inventory and totalCash
          transactions.forEach(t => {
            let item = inventory.find(i => i.category === t.category);
            if (!item && (t.type === "Purchase" || t.type === "Refund")) {
              item = { category: t.category, quantity: 0, total_value: 0 };
              inventory.push(item);
            }
            if (t.type === "Purchase") {
              item.quantity += t.quantity;
              item.total_value += t.amount;
              totalCash -= t.amount;
            } else if (t.type === "Sale") {
              item.quantity -= t.quantity;
              item.total_value -= (item.total_value / (item.quantity + t.quantity)) * t.quantity;
              totalCash += t.amount;
            } else if (t.type === "Refund") {
              item.quantity += t.quantity;
              item.total_value += t.amount;
              totalCash -= t.amount;
            }
          });

          // Process expenses to update totalCash
          expenses.forEach(e => {
            totalCash -= e.amount;
          });

          // Remove empty inventory items
          inventory = inventory.filter(item => item.quantity > 0 || item.total_value > 0);
        }

        updateUI();
      } catch (err) {
        document.getElementById("notification").textContent = "Failed to load data from Google Sheets. Check API key and sharing settings.";
        document.getElementById("notification").classList.remove("hidden");
        setTimeout(() => document.getElementById("notification").classList.add("hidden"), 3000);
        console.error("Error loading data:", err.response ? err.response.data : err.message);
        // Fallback: Reset to initial state if loading fails
        totalCash = 100000;
        localStorage.removeItem("totalCash");
        inventory = [
          { category: "Male Unstitched", quantity: 0, total_value: 0 },
          { category: "Female Unstitched", quantity: 0, total_value: 0 },
          { category: "Male Stitched", quantity: 0, total_value: 0 },
          { category: "Female Stitched", quantity: 0, total_value: 0 }
        ];
        transactions = [];
        expenses = [];
        updateUI();
      } finally {
        document.getElementById("loading").classList.add("hidden");
      }
    }

    async function saveToSheets() {
      try {
        const invData = [["category", "quantity", "total_value"], ...inventory.map(i => [i.category, i.quantity.toString(), i.total_value.toString()])];
        const transData = [["type", "category", "quantity", "amount", "date", "name"], ...transactions.map(t => [t.type, t.category, t.quantity.toString(), t.amount.toString(), t.date, t.name])];
        const expData = [["type", "amount", "date"], ...expenses.map(e => [e.type, e.amount.toString(), e.date])];
        await Promise.all([
          axios.post("http://localhost:3000/save", { sheet: "Inventory", data: invData }),
          axios.post("http://localhost:3000/save", { sheet: "Transactions", data: transData }),
          axios.post("http://localhost:3000/save", { sheet: "Expenses", data: expData }),
        ]);
        localStorage.setItem("totalCash", totalCash.toString());
      } catch (err) {
        document.getElementById("notification").textContent = "Failed to save data. Ensure the server is running on port 3000.";
        document.getElementById("notification").classList.remove("hidden");
        setTimeout(() => document.getElementById("notification").classList.add("hidden"), 3000);
        console.error("Error saving data:", err);
      }
    }

    function updateUI() {
      const totalInvestment = partners.reduce((sum, p) => sum + p.investment, 0);
      const profit = (totalCash || 0) - totalInvestment - expenses.reduce((sum, e) => sum + e.amount, 0);
      document.getElementById("aqilShare").textContent = ((partners[0].investment / totalInvestment) * (profit + totalInvestment)).toFixed(0);
      document.getElementById("talhaShare").textContent = ((partners[1].investment / totalInvestment) * (profit + totalInvestment)).toFixed(0);
      document.getElementById("attaShare").textContent = ((partners[2].investment / totalInvestment) * (profit + totalInvestment)).toFixed(0);
      document.getElementById("waseemShare").textContent = ((partners[3].investment / totalInvestment) * (profit + totalInvestment)).toFixed(0);
      document.getElementById("totalCash").textContent = `${(totalCash || 0).toFixed(2)} PKR`;

      document.getElementById("inventoryList").innerHTML = inventory.map(item => `
        <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200 border border-green-200">
          <div class="text-center">
            <p class="font-medium text-green-800 text-sm">${item.category}</p>
            <p class="text-sm ${item.quantity === 0 ? 'zero-pcs' : ''}">${item.quantity} pcs</p>
            <p class="text-sm">${item.total_value.toFixed(0)} PKR</p>
          </div>
        </div>
      `).join("");

      const allTransactions = [...transactions, ...expenses.map(e => ({
        type: "Expense",
        category: "",
        quantity: "",
        amount: e.amount,
        date: e.date,
        name: e.type
      }))].sort((a, b) => new Date(a.date) - new Date(b.date)); // Reverse order (most recent first)
      document.getElementById("transactionsList").innerHTML = allTransactions.map((t, index) => `
        <div class="bg-white p-3 rounded-lg shadow-md flex justify-between items-center hover:shadow-xl transition-shadow duration-200 border border-green-200">
          <div class="text-sm">
            <p class="font-medium ${t.type === 'Purchase' ? 'text-blue-600' : t.type === 'Sale' ? 'text-green-600' : t.type === 'Refund' ? 'text-yellow-600' : 'text-red-600'}">
              <i class="fas ${t.type === 'Purchase' ? 'fa-shopping-cart' : t.type === 'Sale' ? 'fa-money-bill' : t.type === 'Refund' ? 'fa-undo' : 'fa-wallet'} mr-2"></i>
              ${t.type}
            </p>
            ${t.category ? `<p>${t.category}</p>` : ""}
            ${t.quantity ? `<p>${t.quantity} pcs</p>` : ""}
            <p>${t.amount.toFixed(2)} PKR</p>
            <p>${t.date}</p>
            <p>${t.name}</p>
          </div>
          <button onclick="deleteTransaction(${index})" class="text-red-600 hover:text-red-800 transition-colors">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join("");
    }

    function updateForm() {
      const type = document.getElementById("transactionType").value;
      const commonFields = `
        ${type !== "expense" ? `
          <div>
            <label class="block text-xs font-medium text-gray-700">Category</label>
            <select id="category" class="border p-2 rounded w-full text-sm focus:ring-2 focus:ring-green-500">
              <option value="Male Unstitched">Male Unstitched</option>
              <option value="Female Unstitched">Female Unstitched</option>
              <option value="Male Stitched">Male Stitched</option>
              <option value="Female Stitched">Female Stitched</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700">Quantity</label>
            <input id="quantity" type="number" placeholder="Quantity" class="border p-2 rounded w-full text-sm focus:ring-2 focus:ring-green-500" min="1">
          </div>
        ` : ""}
        <div>
          <label class="block text-xs font-medium text-gray-700">Amount (PKR)</label>
          <input id="amount" type="number" placeholder="Amount" class="border p-2 rounded w-full text-sm focus:ring-2 focus:ring-green-500" min="0" step="0.01">
        </div>
      `;
      document.getElementById("transactionForm").innerHTML = `
        ${type === "expense" ? `
          <div>
            <label class="block text-xs font-medium text-gray-700">Type</label>
            <select id="expenseType" class="border p-2 rounded w-full text-sm focus:ring-2 focus:ring-green-500">
              <option value="Stitching">Stitching</option>
              <option value="Courier">Courier</option>
              <option value="Marketing">Marketing</option>
              <option value="Other">Other</option>
            </select>
          </div>
        ` : `
          <div>
            <label class="block text-xs font-medium text-gray-700">${type === "purchase" ? "Supplier" : "Customer"} Name</label>
            <input id="name" type="text" placeholder="${type === "purchase" ? "Supplier" : "Customer"} Name" class="border p-2 rounded w-full text-sm focus:ring-2 focus:ring-green-500">
          </div>
        `}
        ${commonFields}
        <button onclick="addTransaction()" class="bg-${type === 'purchase' ? 'blue' : type === 'sale' ? 'green' : type === 'refund' ? 'yellow' : 'red'}-500 text-white p-2 rounded-lg hover:bg-${type === 'purchase' ? 'blue' : type === 'sale' ? 'green' : type === 'refund' ? 'yellow' : 'red'}-600 transition-colors text-sm flex items-center">
          <i class="fas fa-plus mr-2"></i> Add ${type.charAt(0).toUpperCase() + type.slice(1)}
        </button>
      `;
    }

    async function addTransaction() {
      const password = prompt("Enter password to record transaction:");
      if (password !== PASSWORD) {
        document.getElementById("notification").textContent = "Incorrect password!";
        document.getElementById("notification").classList.remove("hidden");
        setTimeout(() => document.getElementById("notification").classList.add("hidden"), 3000);
        return;
      }

      const type = document.getElementById("transactionType").value;
      const category = document.getElementById("category")?.value;
      const quantity = parseInt(document.getElementById("quantity")?.value) || 0;
      const amount = parseFloat(document.getElementById("amount").value);
      const name = document.getElementById("name")?.value;
      const expenseType = document.getElementById("expenseType")?.value;

      if ((type !== "expense" && category && quantity > 0 && amount > 0 && name) || (type === "expense" && expenseType && amount > 0)) {
        if (type === "sale" && (!inventory.find(i => i.category === category) || inventory.find(i => i.category === category).quantity < quantity)) {
          document.getElementById("notification").textContent = "Insufficient inventory!";
          document.getElementById("notification").classList.remove("hidden");
          setTimeout(() => document.getElementById("notification").classList.add("hidden"), 3000);
          return;
        }

        if (type !== "expense") {
          let item = inventory.find(i => i.category === category);
          if (!item && (type === "purchase" || type === "refund")) {
            item = { category, quantity: 0, total_value: 0 };
            inventory.push(item);
          }
          if (type === "purchase") {
            item.quantity += quantity;
            item.total_value += amount;
            totalCash -= amount;
          } else if (type === "sale") {
            item.quantity -= quantity;
            item.total_value -= (item.total_value / (item.quantity + quantity)) * quantity;
            totalCash += amount;
          } else if (type === "refund") {
            item.quantity += quantity;
            item.total_value += amount;
            totalCash -= amount;
          }
          transactions.push({ type: type.charAt(0).toUpperCase() + type.slice(1), category, quantity, amount, date: new Date().toISOString().split("T")[0], name });
        } else {
          expenses.push({ type: expenseType, amount, date: new Date().toISOString().split("T")[0] });
          totalCash -= amount;
        }

        await saveToSheets();
        updateUI();
        document.getElementById("transactionForm").querySelectorAll("input, select").forEach(el => el.value = "");
      } else {
        document.getElementById("notification").textContent = "Please fill all fields correctly.";
        document.getElementById("notification").classList.remove("hidden");
        setTimeout(() => document.getElementById("notification").classList.add("hidden"), 3000);
      }
    }

    async function deleteTransaction(index) {
      const password = prompt("Enter password to delete:");
      if (password !== PASSWORD) {
        document.getElementById("notification").textContent = "Incorrect password!";
        document.getElementById("notification").classList.remove("hidden");
        setTimeout(() => document.getElementById("notification").classList.add("hidden"), 3000);
        return;
      }

      const allTransactions = [...transactions, ...expenses.map(e => ({
        type: "Expense",
        category: "",
        quantity: "",
        amount: e.amount,
        date: e.date,
        name: e.type
      }))].sort((a, b) => new Date(a.date) - new Date(b.date));
      const transaction = allTransactions[index];

      if (transaction.type === "Purchase") {
        const item = inventory.find(i => i.category === transaction.category);
        if (item) {
          item.quantity -= transaction.quantity;
          item.total_value -= transaction.amount;
          if (item.quantity <= 0) inventory = inventory.filter(i => i.category !== transaction.category);
        }
        totalCash += transaction.amount;
        transactions = transactions.filter(t => t !== transaction);
      } else if (transaction.type === "Sale") {
        const item = inventory.find(i => i.category === transaction.category);
        if (item) {
          item.quantity += transaction.quantity;
          item.total_value += transaction.amount;
        }
        totalCash -= transaction.amount;
        transactions = transactions.filter(t => t !== transaction);
      } else if (transaction.type === "Refund") {
        const item = inventory.find(i => i.category === transaction.category);
        if (item) {
          item.quantity -= transaction.quantity;
          item.total_value -= transaction.amount;
          if (item.quantity <= 0) inventory = inventory.filter(i => i.category !== transaction.category);
        }
        totalCash += transaction.amount;
        transactions = transactions.filter(t => t !== transaction);
      } else if (transaction.type === "Expense") {
        totalCash += transaction.amount;
        expenses = expenses.filter(e => e.date !== transaction.date || e.amount !== transaction.amount || e.type !== transaction.name);
      }

      await saveToSheets();
      updateUI();
    }

    function exportCSV(type) {
      let data, headers, filename;
      if (type === "inventory") {
        headers = ["category", "quantity", "total_value"];
        data = inventory;
        filename = "inventory.csv";
      } else if (type === "transactions") {
        headers = ["type", "category", "quantity", "amount", "date", "name"];
        data = transactions;
        filename = "transactions.csv";
      } else {
        headers = ["type", "amount", "date"];
        data = expenses;
        filename = "expenses.csv";
      }
      const csv = [headers.join(","), ...data.map(row => headers.map(h => row[h] || "").join(","))].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("toggleTransactions").addEventListener("click", (e) => {
      const list = document.getElementById("transactionsList");
      list.classList.toggle("hidden");
      e.target.textContent = list.classList.contains("hidden") ? "Show" : "Hide";
    });

    updateForm();
    loadData();
  </script>
</body>
</html>